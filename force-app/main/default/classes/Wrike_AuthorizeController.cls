public with sharing class Wrike_AuthorizeController extends Wrike_BaseController {
   
    private String getRedirectURI() {

        return EncodingUtil.urlEncode(
                    URL.getSalesforceBaseUrl().toExternalForm() + '/apex/Wrike_Authorize?return_path='
                    + ApexPages.currentPage().getParameters().get('return_path'),
                'UTF-8');
    }

    public PageReference authorize() {
        
        try {
        	
        	//update oauth settings
        	Map<String, String> oauthKeys = WrikeWebHook.registerOauthClient(getSalesforceHost());
        
            System.debug('ApexPages.currentPage().getParameters() ' + ApexPages.currentPage().getParameters());
    
            if (!ApexPages.currentPage().getParameters().containsKey('return_path'))
                return null;
    
            if(ApexPages.currentPage().getParameters().containsKey('error')) {
             
                PageReference test = new PageReference(
                        URL.getSalesforceBaseUrl().toExternalForm() +
                        ApexPages.currentPage().getParameters().get('return_path'));
                test.setRedirect(true);
                return test;
            }
    
            if(ApexPages.currentPage().getParameters().containsKey('code')) {
                // Redirected from Wrike.com
       
                Wrike_ApiUtils.acquireTokens(getRedirectURI(), 
                            ApexPages.currentPage().getParameters().get('code'),
                            ApexPages.currentPage().getParameters().get('state'));
    
                PageReference test = new PageReference(
                        URL.getSalesforceBaseUrl().toExternalForm() +
                        ApexPages.currentPage().getParameters().get('return_path'));
                test.setRedirect(true);
                return test;
            } else {
    
                // Create state and save in Custom Settings
                // User Permissions Needed:
                // To manage, create, edit, and delete custom settings: 'Customize Application'
    
                Wrike_API__c api = Wrike_API__c.getInstance();
                api.State__c = EncodingUtil.convertToHex(crypto.generateAesKey(128))
                    .substring(0,16).toUpperCase();
    
                upsert api;
    
                String wrikeTarget = Wrike_ApiUtils.getAuthorizeURL();
                wrikeTarget += '&client_id=' + settings.wrikeClientId__c;
                wrikeTarget += '&state=' + api.State__c;
                wrikeTarget += '&redirect_uri=' + getRedirectURI();
                System.debug('wrikeTarget ' + wrikeTarget);
                System.debug('api.State__c ' + api.State__c);
    
                PageReference wrikeAuthorize = new PageReference(wrikeTarget);
                wrikeAuthorize.setRedirect(true);
                return wrikeAuthorize;
            }
            return null;
            
        } catch(Exception ex) { 
            return handleExceptionPageRef(ex); 
            }
   }
   
   public static void validate_AuthorizeController() {
        Integer i = 0;
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
        i++;   
    }
}